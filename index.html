<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>Scanner QR Code - Cam√©ra Optimis√©e</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e293b;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            color: white;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: #000;
        }

        #video {
            width: 100%;
            display: block;
        }

        #canvas {
            display: none;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .scan-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid #10b981;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }

        .scan-area::before,
        .scan-area::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #10b981;
        }

        .scan-area::before {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
        }

        .scan-area::after {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #10b981, transparent);
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: 100%; }
        }

        .status {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 1.1em;
            font-weight: 600;
        }

        .status.success {
            background: #10b981;
        }

        .status.error {
            background: #ef4444;
        }

        .status.scanning {
            background: #3b82f6;
        }

        .controls {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .result-card h3 {
            color: #1e293b;
            margin-bottom: 15px;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
        }

        .result-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .result-table td:first-child {
            font-weight: 600;
            color: #475569;
            width: 40%;
        }

        .tips {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #f59e0b;
        }

        .tips h4 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .tips ul {
            margin-left: 20px;
            color: #78350f;
        }

        .debug-info {
            background: #1e293b;
            color: #94a3b8;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì∏ Scanner QR Code</h1>
        <p>Pointez vers le QR code</p>
    </div>

    <div id="statusBar" class="status scanning">
        üîç Recherche de QR code...
    </div>

    <div class="camera-container">
        <video id="video" playsinline autoplay></video>
        <canvas id="canvas"></canvas>
        <div class="camera-overlay">
            <div class="scan-area">
                <div class="scan-line"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn" class="btn btn-primary">üì∑ D√©marrer la cam√©ra</button>
        <button id="stopBtn" class="btn btn-danger" style="display: none;">‚èπÔ∏è Arr√™ter</button>
        <button id="switchBtn" class="btn btn-secondary" style="display: none;">üîÑ Changer de cam√©ra</button>
    </div>

    <div id="result" style="display: none;"></div>

    <div class="tips">
        <h4>üí° Conseils pour un bon scan :</h4>
        <ul>
            <li><strong>Distance :</strong> Placez-vous √† 15-30 cm du QR code</li>
            <li><strong>Lumi√®re :</strong> Assurez-vous d'avoir un bon √©clairage</li>
            <li><strong>Stabilit√© :</strong> Tenez le t√©l√©phone stable</li>
            <li><strong>Cadrage :</strong> Le QR code doit √™tre dans le carr√© vert</li>
            <li><strong>Nettet√© :</strong> Attendez que l'image soit nette (autofocus)</li>
        </ul>
    </div>

    <div id="debug" class="debug-info"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusBar = document.getElementById('statusBar');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const switchBtn = document.getElementById('switchBtn');
        const resultDiv = document.getElementById('result');
        const debugDiv = document.getElementById('debug');

        let stream = null;
        let scanning = false;
        let currentFacingMode = 'environment'; // 'environment' = cam√©ra arri√®re

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + debugDiv.innerHTML;
        }

        function updateStatus(message, type = 'scanning') {
            statusBar.textContent = message;
            statusBar.className = `status ${type}`;
        }

        async function startCamera() {
            try {
                log('Demande acc√®s cam√©ra...');
                updateStatus('üì∑ D√©marrage de la cam√©ra...', 'scanning');

                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                log('Cam√©ra d√©marr√©e avec succ√®s');
                updateStatus('üîç Recherche de QR code... Cadrez le code dans le carr√© vert', 'scanning');
                
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                switchBtn.style.display = 'block';

                video.addEventListener('loadedmetadata', () => {
                    log(`R√©solution vid√©o: ${video.videoWidth}x${video.videoHeight}`);
                    scanning = true;
                    requestAnimationFrame(scan);
                });

            } catch (error) {
                log(`ERREUR: ${error.message}`);
                updateStatus('‚ùå Impossible d\'acc√©der √† la cam√©ra', 'error');
                alert('Erreur cam√©ra:\n' + error.message + '\n\nV√©rifiez les permissions dans les param√®tres du navigateur.');
            }
        }

        function stopCamera() {
            scanning = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;
            
            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            switchBtn.style.display = 'none';
            
            updateStatus('üì∑ Cam√©ra arr√™t√©e', 'scanning');
            log('Cam√©ra arr√™t√©e');
        }

        async function switchCamera() {
            stopCamera();
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            log(`Changement vers cam√©ra: ${currentFacingMode}`);
            await startCamera();
        }

        function scan() {
            if (!scanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    log(`QR CODE D√âTECT√â: ${code.data.substring(0, 50)}...`);
                    handleQRCode(code.data);
                    return; // Arr√™ter le scan apr√®s d√©tection
                }
            }

            requestAnimationFrame(scan);
        }

        function parseQRData(rawContent) {
            log(`Parsing: ${rawContent}`);

            // Format: SN=xxx;TYPE=xxx;TONNAGE=xxx;OWNER=xxx;REV=xxx;ATELIER=xxx
            if (rawContent.includes('=') && rawContent.includes(';')) {
                try {
                    const structured = {
                        'N¬∞ de s√©rie': '',
                        'Type': '',
                        'Tonnage': '',
                        'D√©tenteur': '',
                        'R√©vision': '',
                        'Atelier': ''
                    };
                    
                    const parts = rawContent.split(';');
                    parts.forEach(part => {
                        const [key, value] = part.split('=').map(s => s.trim());
                        if (key && value) {
                            if (key === 'SN') structured['N¬∞ de s√©rie'] = value;
                            else if (key === 'TYPE') structured['Type'] = value;
                            else if (key === 'TONNAGE') structured['Tonnage'] = value;
                            else if (key === 'OWNER') structured['D√©tenteur'] = value;
                            else if (key === 'REV') structured['R√©vision'] = value;
                            else if (key === 'ATELIER') structured['Atelier'] = value;
                        }
                    });

                    if (structured['N¬∞ de s√©rie']) {
                        return { isStructured: true, data: structured, raw: rawContent };
                    }
                } catch (e) {
                    log(`Erreur parsing: ${e.message}`);
                }
            }

            return { isStructured: false, data: null, raw: rawContent };
        }

        function handleQRCode(data) {
            scanning = false; // Arr√™ter le scan
            
            const parsed = parseQRData(data);
            
            updateStatus('‚úÖ QR Code scann√© avec succ√®s !', 'success');
            
            // Vibration si support√©e
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }

            // Afficher le r√©sultat
            if (parsed.isStructured) {
                resultDiv.innerHTML = `
                    <div class="result-card">
                        <h3>‚úÖ Essieu scann√©</h3>
                        <table class="result-table">
                            ${Object.entries(parsed.data).map(([key, value]) => `
                                <tr>
                                    <td>${key}</td>
                                    <td><strong>${value}</strong></td>
                                </tr>
                            `).join('')}
                        </table>
                        <button onclick="continueScanning()" class="btn btn-primary" style="margin-top: 15px;">
                            ‚û°Ô∏è Scanner l'essieu suivant
                        </button>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="result-card">
                        <h3>‚úÖ QR Code scann√©</h3>
                        <p style="word-wrap: break-word; background: #f8fafc; padding: 15px; border-radius: 8px; font-family: monospace;">
                            ${data}
                        </p>
                        <button onclick="continueScanning()" class="btn btn-primary" style="margin-top: 15px;">
                            ‚û°Ô∏è Scanner un autre code
                        </button>
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
            
            // Auto-scroll vers le r√©sultat
            setTimeout(() => {
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        function continueScanning() {
            resultDiv.style.display = 'none';
            scanning = true;
            updateStatus('üîç Recherche de QR code...', 'scanning');
            requestAnimationFrame(scan);
        }

        // Event listeners
        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
        switchBtn.addEventListener('click', switchCamera);

        // V√©rifier jsQR
        if (typeof jsQR === 'undefined') {
            log('ERREUR: jsQR non charg√©');
            alert('Erreur: Biblioth√®que jsQR non charg√©e. V√©rifiez votre connexion internet.');
        } else {
            log('jsQR charg√© avec succ√®s');
        }

        log('Application pr√™te');
    </script>
</body>
</html>
